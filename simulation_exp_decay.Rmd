---
title: "R code to re-create a simulation for the exponential decay structure for equal cluster sizes"
output: pdf_document
geometry: "left=1.2cm,right=1.2cm,top=1.2cm,bottom=1.2cm"
---

```{r}
# Packages and source programs
library(geepack)
source('FUNCTIONS.R')

# Design
I <- 20        # number of clusters
n <- 30        # number of participants per cluster per period
T <- 5         # number of time periods
q <- I/(T-1)   # number of clusters randomized at each step
sig <- 0.05    # significance level
p0 <- 0.3      # baseline prevalence under control
beta <- c(log(p0/(1-p0)),-0.87,-0.89,-0.91,-0.93) # gently decreasing time-effect 
theta <- 0.4592 # intervention effect on the log odds ratio scale
tau <- 0.06    # within-period correlation
rho <- 0.7715  # decay parameter
times <- 1:T
varrho <- rho^abs(outer(times,times,"-"))
R <- (1-tau)*diag(n*T) + kronecker(tau*varrho,matrix(1,nrow=n,ncol=n)) # exponential decay correlation
trtSeq <- matrix(0,T-1,T) 
trtSeq[upper.tri(trtSeq)] <- 1  # treatment sequences

# Simulate data 
set.seed(20210513)
B <- create.B(I,T,q,beta,theta,trtSeq,n,R) # Create b's as in Qaqish equation 3
y <- create.response(I,T,q,beta,theta,trtSeq,n,B) # Simulate binary outcomes (Qaqish equation 3)

# Fit the model with the true correlation structure
X <- NULL    # Create X matrix for covariates in FITEXPDECAY
for(i in 1:(T-1)){
  for(d in 1:q){
    X <- rbind(X,kronecker(cbind(diag(T),trtSeq[i,]),rep(1,n)))
  }
}
clsize <- rep(n*T,I) # cluster sizes (across all the periods)
clpersize <- clsize/T # cluster-period sizes 
fit <- FITEXPDECAY(y=y, X=X, clsize=clsize, clpersize=clpersize, T=T, maxiter=100, epsilon=0.0001)
fit # mean model, model-based SEs, sandwich SEs, Mancl DeRouen sandwich SEs and correlations

# Fit the model with the working exchangeable correlation structure 
cluster <- rep(1:I,each=T*n)
period <- rep(rep(1:T,each=n),I)
X.ij <- kronecker(trtSeq,rep(1,q))
treatment <- rep(c(t(X.ij)),each=n)
simdata_bin <- data.frame(cbind(y,cluster,period,treatment))
fit_exch <- geeglm(y~treatment+factor(period),id=cluster,data=simdata_bin,
                 family=binomial(link = "logit"), scale.fix=TRUE, corstr="exchangeable")
summary(fit_exch)  # mean model, sandwich SEs and correlation
sqrt(fit_exch$geese$vbeta.naiv[2,2]) # model-based SE for the treatment effect
# Get Mancl DeRouen sandwich variance
alpha <- summary(fit_exch)$corr[1,1]
var <- (1-alpha)*diag(n*T) + alpha*matrix(1,nrow=n*T,ncol=n*T) 
md_var <- md.var(fit_exch,simdata_bin,var)
sqrt(md_var) # Mancl DeRouen sandwich SE for the treatment effect 
 
# Fit the model with the working independence correlation structure 
fit_indep <- geeglm(y~treatment+factor(period),id=cluster,data=simdata_bin,
                 family=binomial(link = "logit"), scale.fix=TRUE, corstr="independence")
summary(fit_indep) # mean model and sandwich SEs 
sqrt(fit_indep$geese$vbeta.naiv[2,2]) # model-based SE for the treatment effect
# Get Mancl DeRouen sandwich variance
var <- diag(n*T)
md_var <- md.var(fit_indep,simdata_bin,var)
sqrt(md_var) # Mancl DeRouen sandwich SE for the treatment effect 
```


